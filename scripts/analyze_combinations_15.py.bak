import pandas as pd
import os
import itertools
from collections import Counter
import time

start_time = time.time()

# ğŸ“ Î”Î¹Î±Î´ÏÎ¿Î¼Î­Ï‚ Î±ÏÏ‡ÎµÎ¯Ï‰Î½
input_path = "data/kino_draws.csv"
output_path = "output/top_15_combinations.csv"
os.makedirs("output", exist_ok=True)

# âœ… Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
try:
    df = pd.read_csv(input_path)
    recent_df = df.tail(500)  # Î‘Î½Î¬Î»Ï…ÏƒÎ· Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Ï‰Î½ 500 ÎºÎ»Î·ÏÏÏƒÎµÏ‰Î½

    number_columns = [col for col in df.columns if col.startswith("num_")]
    recent_draws = recent_df[number_columns].values.tolist()

    # ğŸ§  Î‘Î½Î¬Î»Ï…ÏƒÎ· 15Î¬Î´Ï‰Î½
    all_combinations = []
    for draw in recent_draws:
        draw = sorted(set(draw))
        if len(draw) >= 15:
            combs = itertools.combinations(draw, 15)
            all_combinations.extend(combs)

    # ğŸ“Š Î£Ï…Ï‡Î½ÏŒÏ„Î·Ï„ÎµÏ‚
    counter = Counter(all_combinations)
    most_common = counter.most_common(10)

    # ğŸ’¾ Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ·
    result_df = pd.DataFrame(most_common, columns=["Combination", "Frequency"])
    result_df.to_csv(output_path, index=False)

    elapsed = time.time() - start_time
    print("âœ… ÎŸÎ¹ Ï€Î¹Î¿ ÏƒÏ…Ï‡Î½Î­Ï‚ 15Î¬Î´ÎµÏ‚ Ï…Ï€Î¿Î»Î¿Î³Î¯ÏƒÏ„Î·ÎºÎ±Î½ ÎºÎ±Î¹ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎ±Î½!")
    print(result_df)
    print(f"â±ï¸ Î§ÏÏŒÎ½Î¿Ï‚ ÎµÎºÏ„Î­Î»ÎµÏƒÎ·Ï‚: {elapsed:.2f} Î´ÎµÏ…Ï„ÎµÏÏŒÎ»ÎµÏ€Ï„Î±")

except FileNotFoundError:
    print(f"âŒ Î¤Î¿ Î±ÏÏ‡ÎµÎ¯Î¿ Î´ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ: {input_path}")
except Exception as e:
    print(f"âŒ Î£Ï†Î¬Î»Î¼Î±: {e}")
