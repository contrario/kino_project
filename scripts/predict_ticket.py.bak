# scripts/predict_ticket.py

import pandas as pd
import numpy as np
import joblib
from collections import Counter

# ----------------------------
# ğŸ”¹ Top-10 features (Ï„Î± Î¯Î´Î¹Î± Î¼Îµ Ï„Î¿ training)
top10_features = ['num_8', 'num_4', 'num_14', 'gap_1', 'gap_17', 'gap_43', 'num_12', 'num_5', 'freq_8', 'freq_4']

# ğŸ”¹ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¿Ï… ÎµÎºÏ€Î±Î¹Î´ÎµÏ…Î¼Î­Î½Î¿Ï… Î¼Î¿Î½Ï„Î­Î»Î¿Ï…
model = joblib.load('models/random_forest_best.pkl')

# ----------------------------
# ğŸ”¹ Î•Î¯ÏƒÎ¿Î´Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î· (12 Î±ÏÎ¹Î¸Î¼Î¿Î¯)
user_ticket = [int(x) for x in input("ğŸŸï¸ Î”ÏÏƒÎµ 12 Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚ ÎšÎ™ÎÎŸ Ï‡Ï‰ÏÎ¹ÏƒÎ¼Î­Î½Î¿Ï…Ï‚ Î¼Îµ ÎºÏŒÎ¼Î¼Î±: ").split(',')]

if len(user_ticket) != 12:
    print("âŒ Î ÏÎ­Ï€ÎµÎ¹ Î½Î± Î´ÏÏƒÎµÎ¹Ï‚ Î±ÎºÏÎ¹Î²ÏÏ‚ 12 Î±ÏÎ¹Î¸Î¼Î¿ÏÏ‚.")
    exit()

# ----------------------------
# ğŸ”¹ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ Î³Î¹Î± Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î¼Îµ context (Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÎ¬ feature data)
df = pd.read_csv('data/kino_features.csv')

# Î Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ Ï„Î·Î½ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Î³ÏÎ±Î¼Î¼Î® (Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ draw) Î³Î¹Î± Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î¼Îµ Ï„Î± features Ï„Î¿Ï… Î½Î­Î¿Ï… Î´ÎµÎ»Ï„Î¯Î¿Ï…
last_row = df.iloc[-1]

# Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± feature row Î³Î¹Î± Ï„Î¿ Î´ÎµÎ»Ï„Î¯Î¿
new_data = {}

for col in top10_features:
    if col.startswith('num_'):
        num = int(col.split('_')[1])
        new_data[col] = 1 if num in user_ticket else 0
    elif col.startswith('freq_'):
        num = int(col.split('_')[1])
        freq_col = f'freq_{num}'
        new_data[col] = last_row[freq_col]
    elif col.startswith('gap_'):
        num = int(col.split('_')[1])
        gap_col = f'gap_{num}'
        new_data[col] = last_row[gap_col]
    else:
        new_data[col] = last_row[col]  # Ï€.Ï‡. std_deviation Î® sum_total

# ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® ÏƒÎµ DataFrame
input_df = pd.DataFrame([new_data])

# ----------------------------
# ğŸ”® Î ÏÏŒÎ²Î»ÎµÏˆÎ·
prediction = model.predict(input_df)[0]
probability = model.predict_proba(input_df)[0][1]  # Ï€Î¹Î¸Î±Î½ÏŒÏ„Î·Ï„Î± Î³Î¹Î± class 1 (7-hit)

# ----------------------------
# ğŸ–¨ï¸ Î‘Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±
print("\nğŸ“Š Î ÏÎ¿Î²Î»ÎµÏ€ÏŒÎ¼ÎµÎ½Î± Ï‡Î±ÏÎ±ÎºÏ„Î·ÏÎ¹ÏƒÏ„Î¹ÎºÎ¬:")
print(input_df)

print("\nğŸ¯ Î ÏÏŒÎ²Î»ÎµÏˆÎ·:")
print(f"â¡ï¸ {'7-hit' if prediction == 1 else 'ÎŒÏ‡Î¹ 7-hit'} (Î Î¹Î¸Î±Î½ÏŒÏ„Î·Ï„Î±: {probability:.2f})")
