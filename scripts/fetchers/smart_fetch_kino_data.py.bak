from datetime import datetime, timedelta
import requests
from scripts.utils.logger import log_info, log_error


def fetch_recent_draws(limit=100):
    """
    Fetches recent KINO draws with fallback ÏƒÏ„Î¹Ï‚ Ï€ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½ÎµÏ‚ Î¼Î­ÏÎµÏ‚ Î±Î½ Î· ÏƒÎ·Î¼ÎµÏÎ¹Î½Î® Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹.
    """
    try:
        attempts = 3  # Î´Î¿ÎºÎ¹Î¼Î¬Î¶ÎµÎ¹ Ï„Î¹Ï‚ 3 Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ Î·Î¼Î­ÏÎµÏ‚
        all_draws = []

        for i in range(attempts):
            day = datetime.today() - timedelta(days=i)
            url = f"https://api.opap.gr/draws/v3.0/1100/draw-date/{day.date()}/{day.date()}"
            response = requests.get(url)
            if response.status_code == 200:
                data = response.json()
                draws = data.get("content", [])
                all_draws.extend(draws)
                if len(all_draws) >= limit:
                    break

        if all_draws:
            log_info(f"ğŸ“¥ Î•Ï€Î¹Ï„Ï…Ï‡Î®Ï‚ Î±Î½Î¬ÎºÏ„Î·ÏƒÎ· {min(limit, len(all_draws))} ÎºÎ»Î·ÏÏÏƒÎµÏ‰Î½.")
            return all_draws[-limit:]
        else:
            raise Exception("Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÎºÎ»Î·ÏÏÏƒÎµÎ¹Ï‚ ÏƒÏ„Î¹Ï‚ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯ÎµÏ‚ 3 Î·Î¼Î­ÏÎµÏ‚.")

    except Exception as e:
        log_error(f"âŒ Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Î½Î¬ÎºÏ„Î·ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: {e}")
        return None


if __name__ == "__main__":
    fetch_recent_draws(10)



