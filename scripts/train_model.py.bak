# scripts/train_model.py

import pandas as pd
import numpy as np
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestClassifier
import joblib
import os
import ast

def numbers_to_vector(numbers, max_number=80):
    """ÎœÎµÏ„Î±Ï„ÏÎ­Ï€ÎµÎ¹ Î»Î¯ÏƒÏ„Î± Î±ÏÎ¹Î¸Î¼ÏÎ½ ÏƒÎµ Î´Ï…Î±Î´Î¹ÎºÏŒ vector Ï€Î±ÏÎ¿Ï…ÏƒÎ¯Î±Ï‚."""
    vector = [0] * max_number
    for n in numbers:
        if isinstance(n, int) and 1 <= n <= max_number:
            vector[n - 1] = 1
    return vector

# ğŸ“¥ Î¦ÏŒÏÏ„Ï‰ÏƒÎ· dataset
dataset_path = os.path.join("data", "kino_dataset_cleaned.csv")
df = pd.read_csv(dataset_path)
print(f"âœ… Dataset Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ: {df.shape}")

# ğŸ” Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Î¼Î· Î­Î³ÎºÏ…ÏÏ‰Î½ labels (ÏŒÏ‡Î¹ string Î® Î»Î¯ÏƒÏ„Î±)
df = df[df["label"].apply(lambda x: isinstance(x, (str, list)))]

import pandas as pd
import numpy as np
import os
import joblib
from sklearn.ensemble import RandomForestClassifier
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score
import ast

# === Î¡ÏÎ¸Î¼Î¹ÏƒÎ· Î´Î¹Î±Î´ÏÎ¿Î¼ÏÎ½ ===
DATA_PATH = "data/kino_dataset_cleaned.csv"
MODEL_PATH = "models/best_model.pkl"

# === Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î´Î¹Î±Î½ÏÏƒÎ¼Î±Ï„Î¿Ï‚ Î±Ï€ÏŒ Î»Î¯ÏƒÏ„Î± Î±ÏÎ¹Î¸Î¼ÏÎ½ ===
def numbers_to_vector(numbers):
    vector = np.zeros(80, dtype=int)
    for n in numbers:
        if 1 <= n <= 80:
            vector[n - 1] = 1
    return vector

# === ÎœÎµÏ„Î±Ï„ÏÎ¿Ï€Î® label Î¼Îµ Î±ÏƒÏ†Î¬Î»ÎµÎ¹Î± ===
def parse_label(x):
    try:
        if isinstance(x, str):
            x = ast.literal_eval(x)
        if isinstance(x, list):
            return numbers_to_vector(x)
    except Exception:
        return None
    return None

# === Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½ ===
if not os.path.exists(DATA_PATH):
    print(f"âŒ Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎµ Ï„Î¿ Î±ÏÏ‡ÎµÎ¯Î¿: {DATA_PATH}")
    exit()

df = pd.read_csv(DATA_PATH)
print(f"âœ… Dataset Ï†Î¿ÏÏ„ÏÎ¸Î·ÎºÎµ: {df.shape}")

# === Î•Ï†Î±ÏÎ¼Î¿Î³Î® Î¼ÎµÏ„Î±Ï„ÏÎ¿Ï€Î®Ï‚ ===
df["vector"] = df["label"].apply(parse_label)

# === Î¦Î¹Î»Ï„ÏÎ¬ÏÎ¹ÏƒÎ¼Î± Î­Î³ÎºÏ…ÏÏ‰Î½ Ï„Î¹Î¼ÏÎ½ ===
df = df[df["vector"].notna()]
print(f"ğŸ“Š ÎˆÎ³ÎºÏ…ÏÎ± Ï€Î±ÏÎ±Î´ÎµÎ¯Î³Î¼Î±Ï„Î± Î¼ÎµÏ„Î¬ Ï„Î· Î¼ÎµÏ„Î±Ï„ÏÎ¿Ï€Î®: {len(df)}")

if df.empty:
    print("âŒ Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­Î³ÎºÏ…ÏÎ± Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± ÎµÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ·.")
    exit()

# === Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î± X ÎºÎ±Î¹ y ===
X = df.drop(columns=["label", "vector"]).values
y = np.vstack(df["vector"].values)

print(f"ğŸ“Š X shape: {X.shape}")
print(f"ğŸ“Š y shape: {y.shape}")

# === Î”Î¹Î±Ï‡Ï‰ÏÎ¹ÏƒÎ¼ÏŒÏ‚ ÏƒÎµ train/test ===
X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# === Î•ÎºÏ€Î±Î¯Î´ÎµÏ…ÏƒÎ· Î¼Î¿Î½Ï„Î­Î»Î¿Ï… ===
model = RandomForestClassifier(n_estimators=100, random_state=42)
model.fit(X_train, y_train)
print("âœ… ÎœÎ¿Î½Ï„Î­Î»Î¿ ÎµÎºÏ€Î±Î¹Î´ÎµÏÏ„Î·ÎºÎµ")

# === Î‘Î¾Î¹Î¿Î»ÏŒÎ³Î·ÏƒÎ· ===
y_pred = model.predict(X_test)
accuracy = accuracy_score(y_test, y_pred)
print(f"ğŸ“ˆ Accuracy: {accuracy:.4f}")

# === Î‘Ï€Î¿Î¸Î®ÎºÎµÏ…ÏƒÎ· Î¼Î¿Î½Ï„Î­Î»Î¿Ï… ===
os.makedirs(os.path.dirname(MODEL_PATH), exist_ok=True)
joblib.dump(model, MODEL_PATH)
print(f"âœ… Î¤Î¿ Î¼Î¿Î½Ï„Î­Î»Î¿ Î±Ï€Î¿Î¸Î·ÎºÎµÏÏ„Î·ÎºÎµ ÏƒÏ„Î¿: {MODEL_PATH}")



